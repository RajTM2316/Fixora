{% extends "base.html" %}
{% block title %}Fixora | Provider Dashboard{% endblock %}


{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    brand: {
                        dark: '#0f172a',
                        primary: '#0066ff',
                        action: '#4f46e5',
                        success: '#10b981',
                        danger: '#ef4444',
                        surface: '#f8fafc'
                    }
                }
            }
        }
    }
</script>


<style>
    .glass-panel {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-top: 1px solid rgba(0,0,0,0.05);
    }
    .tap-effect:active { transform: scale(0.98); }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
</style>


<body class="bg-brand-surface min-h-screen text-slate-800 font-sans">


<header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-brand-action rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-md">
                <i class="fa-solid fa-wrench text-sm"></i>
            </div>
            <span class="font-bold text-xl text-brand-dark tracking-tight">Fixora<span class="text-brand-action">Provider</span></span>
        </div>


        <div class="flex items-center gap-4">
            <div class="hidden sm:block text-right">
                <p class="text-sm font-bold text-brand-dark leading-none">{{ user.username }}</p>
                <p class="text-xs text-gray-500 mt-1 font-medium">Service Provider</p>
            </div>
            <div class="w-10 h-10 bg-indigo-50 text-brand-action rounded-full flex items-center justify-center font-bold border border-indigo-100 shadow-inner">
                {{ user.username|slice:":1"|upper }}
            </div>
            <div class="h-6 w-px bg-gray-200 mx-1"></div>
            <a href="{% url 'logout' %}"
                class="bg-gray-900 hover:bg-black text-white text-sm font-semibold px-4 py-2 rounded-md flex items-center gap-2 transition">
                    <i class="fa-solid fa-arrow-right-from-bracket text-xs"></i>
                    Logout
                </a>
        </div>
    </div>
</header>


<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
   
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-brand-dark">Dashboard Overview</h1>
        <p class="text-gray-500 text-sm mt-1">Manage your active jobs, incoming requests, and history.</p>
    </div>


    {% if active_job %}
    <section class="mb-8 animate-fade-in">
        <div class="bg-gradient-to-r from-brand-action to-indigo-700 rounded-2xl shadow-lg relative overflow-hidden">
            <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 rounded-full bg-white opacity-10 blur-2xl"></div>
           
            <div class="p-6 sm:p-8 relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex-1 text-white">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="bg-emerald-400/20 text-emerald-300 border border-emerald-400/30 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
                            Active Job in Progress
                        </span>
                    </div>
                    <h2 class="text-3xl font-bold mb-4">{{ active_job.provider_service.service.name }}</h2>
                   
                    <div class="flex flex-col sm:flex-row gap-4 sm:gap-8 text-indigo-100">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                                <i class="fa-solid fa-user text-sm"></i>
                            </div>
                            <span class="font-medium">{{ active_job.customer.user.username }}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                                <i class="fa-solid fa-location-dot text-sm"></i>
                            </div>
                            <span class="font-medium">{{ active_job.address_text|truncatechars:40 }}</span>
                        </div>
                    </div>
                </div>


                <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                    <a href="/chat/{{ active_job.id }}/" class="bg-white/10 hover:bg-white/20 border border-white/20 text-white font-semibold py-3 px-6 rounded-xl flex items-center justify-center gap-2 transition-colors tap-effect">
                        <i class="fa-solid fa-comment-dots"></i>
                        Open Chat
                    </a>
                    <form method="POST" action="{% url 'complete_request' active_job.id %}" class="w-full md:w-auto">
                        {% csrf_token %}
                        <button type="submit" class="w-full bg-white text-brand-action hover:bg-gray-50 font-bold py-3 px-8 rounded-xl shadow-md transition-all tap-effect flex items-center justify-center gap-2">
                            <i class="fa-solid fa-circle-check"></i>
                            Mark Completed
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </section>
    {% endif %}


    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
       
        <div class="lg:col-span-2 space-y-6">
            <div class="flex items-center justify-between border-b border-gray-200 pb-4">
                <div class="flex items-center gap-2">
                    <h2 class="text-lg font-bold text-brand-dark">New Requests</h2>
                    {% if incoming_requests.count > 0 %}
                    <span class="bg-red-100 text-red-600 text-xs font-bold px-2.5 py-1 rounded-full border border-red-200">
                        {{ incoming_requests.count }} New
                    </span>
                    {% endif %}
                </div>
            </div>


            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                {% for request in incoming_requests %}
                <div class="bg-white rounded-2xl shadow-sm hover:shadow-md transition-shadow duration-300 border border-gray-100 overflow-hidden flex flex-col">
                    <div class="p-5 border-b border-gray-50 flex-1">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-brand-dark text-lg">{{ request.provider_service.service.name }}</h3>
                                <p class="text-xs text-gray-500 font-medium mt-1 flex items-center gap-1.5">
                                    <i class="fa-solid fa-user-tag text-gray-400"></i>
                                    {{ request.customer.user.username }}
                                </p>
                            </div>
                            <span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded uppercase tracking-wide">Pending</span>
                        </div>


                        <div class="space-y-2 mb-4">
                            <div class="flex items-start gap-2.5 text-sm text-gray-600 bg-gray-50/80 p-3 rounded-lg border border-gray-100">
                                <i class="fa-solid fa-location-dot text-brand-action mt-0.5"></i>
                                <span class="leading-snug">{{ request.address_text }}</span>
                            </div>
                           
                            {% if request.problem_description %}
                            <div class="flex items-start gap-2.5 text-sm text-gray-600 bg-gray-50/80 p-3 rounded-lg border border-gray-100">
                                <i class="fa-solid fa-circle-info text-brand-action mt-0.5"></i>
                                <span class="leading-snug italic">{{ request.problem_description }}</span>
                            </div>
                            {% endif %}
                        </div>


                        {% with request.servicerequestimage_set.all as images %}
                        {% if images %}
                        <div class="flex gap-2 overflow-x-auto scrollbar-hide py-1">
                            {% for img in images %}
                                <img src="{{ img.image.url }}" class="w-16 h-16 object-cover rounded-lg border border-gray-200 shadow-sm flex-shrink-0">
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>


                    <div class="p-4 bg-gray-50 grid grid-cols-2 gap-3 mt-auto">
                        <a href="{% url 'reject_request' request.id %}" class="py-2.5 rounded-xl border border-gray-300 bg-white text-gray-600 font-semibold text-sm hover:bg-gray-100 transition-colors text-center tap-effect flex items-center justify-center gap-2">
                            <i class="fa-solid fa-xmark"></i> Ignore
                        </a>
                        <a href="{% url 'accept_request' request.id %}" class="py-2.5 rounded-xl bg-brand-dark hover:bg-black text-white font-semibold text-sm shadow-md transition-colors text-center tap-effect flex items-center justify-center gap-2">
                            <i class="fa-solid fa-check"></i> Accept Job
                        </a>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-full flex flex-col items-center justify-center py-16 bg-white rounded-2xl border border-dashed border-gray-300 text-center px-4">
                    <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                        <i class="fa-solid fa-inbox text-2xl text-gray-400"></i>
                    </div>
                    <h3 class="text-brand-dark font-bold text-lg mb-1">No pending requests</h3>
                    <p class="text-gray-500 text-sm">When customers request your service, they will appear here.</p>
                </div>
                {% endfor %}
            </div>
        </div>


        <div class="lg:col-span-1">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden sticky top-24">
                <div class="p-5 border-b border-gray-100 flex items-center justify-between bg-gray-50/50">
                    <h2 class="text-base font-bold text-brand-dark flex items-center gap-2">
                        <i class="fa-solid fa-clock-rotate-left text-gray-400"></i>
                        Recent History
                    </h2>
                </div>
               
                <div class="divide-y divide-gray-100">
                    {% for job in job_history %}
                    <div class="p-5 hover:bg-gray-50 transition-colors group">
                        <div class="flex justify-between items-start mb-1">
                            <p class="font-bold text-brand-dark text-sm group-hover:text-brand-action transition-colors">
                                {{ job.provider_service.service.name }}
                            </p>
                            {% if job.status == 'Completed' %}
                                <span class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100">{{ job.status }}</span>
                            {% elif job.status == 'Cancelled' or job.status == 'Rejected' %}
                                <span class="text-[10px] font-bold text-red-600 bg-red-50 px-2 py-0.5 rounded border border-red-100">{{ job.status }}</span>
                            {% else %}
                                <span class="text-[10px] font-bold text-gray-600 bg-gray-100 px-2 py-0.5 rounded border border-gray-200">{{ job.status }}</span>
                            {% endif %}
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-500 mt-2">
                            <span class="flex items-center gap-1.5"><i class="fa-regular fa-user"></i> {{ job.customer.user.username }}</span>
                            <span>{{ job.request_date|date:"M d, Y" }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="p-8 text-center">
                        <i class="fa-solid fa-clipboard-list text-gray-300 text-3xl mb-3"></i>
                        <p class="text-gray-500 text-sm">No job history found yet.</p>
                    </div>
                    {% endfor %}
                </div>
               
                {% if job_history %}
                <div class="p-4 border-t border-gray-100 text-center bg-gray-50">
                    <button class="text-brand-action font-semibold text-sm hover:underline">View All History</button>
                </div>
                {% endif %}
            </div>
        </div>


    </div>
</main>


</body>
{% endblock %}

